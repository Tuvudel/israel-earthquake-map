<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Earthquake Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Internal CSS -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #f8f9fa;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        select {
            padding: 0.25rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            height: 100%;
            background-color: #f5f5f5;
        }

        .info-panel {
            width: 300px;
            padding: 1rem;
            background-color: #f8f9fa;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .info-panel h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }

        #earthquake-details {
            margin-bottom: 1.5rem;
        }

        .statistics h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .statistics p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        footer {
            padding: 0.6rem 1rem;
            background-color: #f8f9fa;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            border-top: 1px solid #ddd;
        }

        /* Styling for earthquake markers */
        .earthquake-marker {
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            border: 1px solid rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            
            .info-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }

        .legend-item {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
            border: 1px solid #000;
        }
        
        #status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 80%;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Israel Earthquake Map</h1>
        <div class="controls">
            <div class="filter-group">
                <label for="magnitude-filter">Minimum Magnitude:</label>
                <select id="magnitude-filter">
                    <option value="0">All</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                    <option value="5">5+</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="date-filter">Time Period:</label>
                <select id="date-filter">
                    <option value="all">All Time</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                </select>
            </div>
        </div>
    </header>
    
    <main>
        <!-- This div will hold our map -->
        <div id="map"></div>
        <div id="status-message"></div>
        
        <div class="info-panel">
            <h2>Earthquake Information</h2>
            <div id="earthquake-details">
                <p>Select an earthquake on the map to view details.</p>
            </div>
            <div class="statistics">
                <h3>Statistics</h3>
                <p>Total earthquakes: <span id="total-count">0</span></p>
                <p>Average magnitude: <span id="avg-magnitude">0</span></p>
            </div>
        </div>
    </main>
    
    <footer>
        <p>Data source: Israel Geophysical Institute</p>
    </footer>

    <!-- Leaflet JavaScript - Loading before our application code -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Main application script -->
    <script>
        // Show a status message to the user
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.backgroundColor = isError ? '#ffeeee' : 'white';
            statusEl.style.borderLeft = isError ? '4px solid red' : '4px solid #4682B4';
        }
        
        // Hide the status message
        function hideStatus() {
            document.getElementById('status-message').style.display = 'none';
        }

        /**
         * EarthquakeData class - Handles earthquake data processing
         */
        class EarthquakeData {
            constructor() {
                this.rawData = []; // Stores the original, unfiltered data
                this.filteredData = []; // Stores filtered data based on user selections
                this.isDataLoaded = false;
            }

            /**
             * Loads earthquake data from a CSV file
             * @param {string} csvUrl - URL to the CSV file
             * @returns {Promise} - Promise that resolves when data is loaded
             */
            async loadFromCsv(csvUrl) {
                showStatus("Loading earthquake data from CSV...");
                
                try {
                    const response = await fetch(csvUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch CSV: ${response.status} ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Parse CSV data using PapaParse
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors && results.errors.length > 0) {
                                console.warn("CSV parsing had errors:", results.errors);
                            }
                            
                            this.processRawData(results.data);
                            hideStatus();
                        },
                        error: (error) => {
                            console.error("CSV parsing error:", error);
                            showStatus(`Error parsing CSV: ${error.message}`, true);
                        }
                    });
                } catch (error) {
                    console.error("CSV loading error:", error);
                    showStatus(`Error loading earthquake data: ${error.message}`, true);
                    throw error;
                }
            }

            /**
             * Processes raw data after loading
             * @param {Array} data - Array of earthquake event objects
             */
            processRawData(data) {
                // Store the raw data
                this.rawData = data.map(item => {
                    // Ensure proper typing and format for all properties
                    return {
                        epiid: item.epiid ? item.epiid.replace(/^'|'$/g, '') : '', // Remove single quotes from IDs
                        dateTime: new Date(item.DateTime || ''),
                        magnitude: parseFloat(item.Mag) || 0,
                        latitude: parseFloat(item.Lat) || 0,
                        longitude: parseFloat(item.Long) || 0,
                        depth: parseFloat(item['Depth(Km)']) || 0,
                        region: item.Region || 'Unknown',
                        type: item.Type || 'Unknown'
                    };
                });

                // Initially, filtered data is the same as raw data
                this.filteredData = [...this.rawData];
                this.isDataLoaded = true;
                
                // Notify that data is loaded
                const event = new CustomEvent('earthquakeDataLoaded');
                window.dispatchEvent(event);
            }

            /**
             * Applies filters to the earthquake data
             * @param {Object} filters - Filters to apply
             * @param {number} filters.minMagnitude - Minimum magnitude filter
             * @param {string} filters.timePeriod - Time period filter ('all', 'week', 'month')
             * @returns {Array} - Filtered earthquake data
             */
            applyFilters(filters = {}) {
                const { minMagnitude = 0, timePeriod = 'all' } = filters;
                
                // Start with all data
                let filtered = [...this.rawData];
                
                // Apply magnitude filter
                if (minMagnitude > 0) {
                    filtered = filtered.filter(quake => quake.magnitude >= minMagnitude);
                }
                
                // Apply time period filter
                if (timePeriod !== 'all') {
                    const now = new Date();
                    let cutoffDate;
                    
                    if (timePeriod === 'week') {
                        cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    } else if (timePeriod === 'month') {
                        cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    }
                    
                    if (cutoffDate) {
                        filtered = filtered.filter(quake => quake.dateTime >= cutoffDate);
                    }
                }
                
                this.filteredData = filtered;
                return this.filteredData;
            }

            /**
             * Gets statistics about the current filtered data
             * @returns {Object} - Statistics object
             */
            getStatistics() {
                const data = this.filteredData;
                const count = data.length;
                
                // Calculate average magnitude
                const totalMagnitude = data.reduce((sum, quake) => sum + quake.magnitude, 0);
                const avgMagnitude = count > 0 ? (totalMagnitude / count).toFixed(2) : 0;
                
                // Find max magnitude
                const maxMagnitude = count > 0 ? Math.max(...data.map(quake => quake.magnitude)) : 0;
                
                return {
                    count,
                    avgMagnitude,
                    maxMagnitude
                };
            }
        }

        // Create a single instance
        const earthquakeData = new EarthquakeData();

        // Main function to initialize the application
        async function initApp() {
            try {
                showStatus("Setting up the application...");
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    throw new Error("Map library not loaded. Please check your internet connection and try again.");
                }
                
                // Initialize the map centered on the region
                const map = initializeMap();
                
                // Define the GitHub URL for the CSV file
                // Note: This URL points to the raw content of the CSV file in your GitHub repository
                // Replace with your actual GitHub repository path
                const csvUrl = 'https://raw.githubusercontent.com/Tuvudel/israel-map/main/last30_event.csv';
                
                // Load data from the CSV file
                await earthquakeData.loadFromCsv(csvUrl);
                
                // Listen for the data loaded event
                window.addEventListener('earthquakeDataLoaded', () => {
                    // Display earthquake markers
                    displayEarthquakeMarkers(map, earthquakeData.filteredData);
                    
                    // Update statistics display
                    updateStatistics();
                    
                    // Add a legend to the map
                    addLegendToMap(map);
                });
                
                // Set up event listeners for filters
                setupFilterListeners(map);
                
            } catch (error) {
                console.error("Application initialization error:", error);
                showStatus(`Error initializing application: ${error.message}. Please reload the page or try a different browser.`, true);
            }
        }

        /**
         * Initializes the Leaflet map centered on the region
         * @returns {Object} - Leaflet map instance
         */
        function initializeMap() {
            try {
                // Center coordinates based on actual earthquake data range
                const mapCenter = [32.25, 29.31];
                
                // Create map instance with initial view
                const map = L.map('map').setView(mapCenter, 7);
                
                // Add the base tile layer (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                return map;
            } catch (error) {
                console.error("Map initialization error:", error);
                throw new Error("Failed to initialize map: " + error.message);
            }
        }

        /**
         * Displays earthquake markers on the map
         * @param {Object} map - Leaflet map instance
         * @param {Array} earthquakes - Array of earthquake data objects
         */
        function displayEarthquakeMarkers(map, earthquakes) {
            // Clear existing markers if any
            if (window.earthquakeMarkers) {
                window.earthquakeMarkers.clearLayers();
            }
            
            // Create a layer group for earthquake markers
            window.earthquakeMarkers = L.layerGroup().addTo(map);
            
            // Process each earthquake
            earthquakes.forEach(quake => {
                // Skip if coordinates are invalid
                if (!quake.latitude || !quake.longitude) return;
                
                // Determine marker size based on magnitude
                const markerSize = calculateMarkerSize(quake.magnitude);
                
                // Determine marker color based on depth
                const markerColor = calculateMarkerColor(quake.depth);
                
                // Create a circular marker
                const marker = L.circleMarker([quake.latitude, quake.longitude], {
                    radius: markerSize,
                    fillColor: markerColor,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Add popup with information
                const popupContent = `
                    <strong>Magnitude:</strong> ${quake.magnitude}<br>
                    <strong>Date & Time:</strong> ${formatDateTime(quake.dateTime)}<br>
                    <strong>Depth:</strong> ${quake.depth} km<br>
                    <strong>Region:</strong> ${quake.region}<br>
                    <strong>Type:</strong> ${quake.type}
                `;
                marker.bindPopup(popupContent);
                
                // Add click event to display details in the info panel
                marker.on('click', () => {
                    displayEarthquakeDetails(quake);
                });
                
                // Add the marker to the layer group
                marker.addTo(window.earthquakeMarkers);
            });
        }

        /**
         * Adds a legend to the map explaining the marker colors and sizes
         * @param {Object} map - Leaflet map instance
         */
        function addLegendToMap(map) {
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                
                div.innerHTML = `
                    <h4>Legend</h4>
                    <div><strong>Depth:</strong></div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFD700;"></div>
                        <span>< 5 km (Very Shallow)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFA500;"></div>
                        <span>5-10 km (Shallow)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FF6347;"></div>
                        <span>10-20 km (Medium)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FF0000;"></div>
                        <span>> 20 km (Deep)</span>
                    </div>
                    <div><strong>Size:</strong> Proportional to magnitude</div>
                `;
                
                return div;
            };
            
            legend.addTo(map);
        }

        /**
         * Calculates marker size based on earthquake magnitude
         * @param {number} magnitude - Earthquake magnitude
         * @returns {number} - Marker radius in pixels
         */
        function calculateMarkerSize(magnitude) {
            // Minimum size of 5, scales up with magnitude
            return Math.max(5, magnitude * 2);
        }

        /**
         * Calculates marker color based on earthquake depth
         * @param {number} depth - Earthquake depth in km
         * @returns {string} - Color in hex format
         */
        function calculateMarkerColor(depth) {
            // Color ranges from yellow (shallow) to red (deep)
            if (depth < 5) return '#FFD700'; // Yellow for very shallow
            if (depth < 10) return '#FFA500'; // Orange for shallow
            if (depth < 20) return '#FF6347'; // Tomato for medium
            return '#FF0000'; // Red for deep
        }

        /**
         * Formats a date object to a readable string
         * @param {Date} dateObj - Date object
         * @returns {string} - Formatted date string
         */
        function formatDateTime(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) {
                return 'Unknown';
            }
            
            return dateObj.toLocaleString();
        }

        /**
         * Displays earthquake details in the info panel
         * @param {Object} quake - Earthquake data object
         */
        function displayEarthquakeDetails(quake) {
            const detailsElement = document.getElementById('earthquake-details');
            
            detailsElement.innerHTML = `
                <div class="detail-item">
                    <strong>Magnitude:</strong> ${quake.magnitude}
                </div>
                <div class="detail-item">
                    <strong>Date & Time:</strong> ${formatDateTime(quake.dateTime)}
                </div>
                <div class="detail-item">
                    <strong>Coordinates:</strong> ${quake.latitude.toFixed(4)}, ${quake.longitude.toFixed(4)}
                </div>
                <div class="detail-item">
                    <strong>Depth:</strong> ${quake.depth} km
                </div>
                <div class="detail-item">
                    <strong>Region:</strong> ${quake.region || 'Unknown'}
                </div>
                <div class="detail-item">
                    <strong>Event Type:</strong> ${quake.type}
                </div>
                <div class="detail-item">
                    <strong>Event ID:</strong> ${quake.epiid}
                </div>
            `;
        }

        /**
         * Updates the statistics display
         */
        function updateStatistics() {
            const stats = earthquakeData.getStatistics();
            
            document.getElementById('total-count').textContent = stats.count;
            document.getElementById('avg-magnitude').textContent = stats.avgMagnitude;
        }

        /**
         * Sets up event listeners for filter controls
         * @param {Object} map - Leaflet map instance
         */
        function setupFilterListeners(map) {
            const magnitudeFilter = document.getElementById('magnitude-filter');
            const dateFilter = document.getElementById('date-filter');
            
            // Function to apply all current filters
            const applyFilters = () => {
                const filters = {
                    minMagnitude: parseFloat(magnitudeFilter.value),
                    timePeriod: dateFilter.value
                };
                
                // Apply filters and get filtered data
                const filteredData = earthquakeData.applyFilters(filters);
                
                // Update map markers
                displayEarthquakeMarkers(map, filteredData);
                
                // Update statistics
                updateStatistics();
            };
            
            // Add event listeners
            magnitudeFilter.addEventListener('change', applyFilters);
            dateFilter.addEventListener('change', applyFilters);
        }
        
        // Start the application when the page is fully loaded
        window.addEventListener('load', initApp);
    </script>
</body>
</html>